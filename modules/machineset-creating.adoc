// Module included in the following assemblies:
//
// * machine-management/creating-infrastructure-machinesets.adoc

[id="machineset-creating-{context}"]
= Creating a MachineSet

.Prerequisites

* Deploy an {product-title} cluster.
* Install the `oc` command line and log in as a user with `cluster-admin`
permission.

.Procedure

Additionally to the ones created by the installer you can create your own MachineSets to dynamically manage the machine compute resources for specific workloads of your choice.

This is an example of a new machineSet running in `us-east-1a` that will create new nodes labeled with `node-role.kubernetes.io/<role>: ""`

[source,yaml]
----
apiVersion: machine.openshift.io/v1beta1
kind: MachineSet
metadata:
  labels:
    machine.openshift.io/cluster-api-cluster: <clusterID>
  name: <clusterID>-<role>-us-east-1a
  namespace: openshift-machine-api
spec:
  replicas: 1
  selector:
    matchLabels:
      machine.openshift.io/cluster-api-cluster: <clusterID>
      machine.openshift.io/cluster-api-machine-role: <role>
      machine.openshift.io/cluster-api-machine-type: <role>
      machine.openshift.io/cluster-api-machineset: <clusterID>-<role>-us-east-1a
  template:
    metadata:
      labels:
        machine.openshift.io/cluster-api-cluster: <clusterID>
        machine.openshift.io/cluster-api-machine-role: <role>
        machine.openshift.io/cluster-api-machine-type: <role>
        machine.openshift.io/cluster-api-machineset: <clusterID>-worker-us-east-1a
    spec:
      metadata:
        labels:
          node-role.kubernetes.io/<role>: ""    
      providerSpec:
        value:
          ami:
            id: <amiID>
          apiVersion: awsproviderconfig.openshift.io/v1beta1
          blockDevices:
            - ebs:
                iops: 0
                volumeSize: 120
                volumeType: gp2
          credentialsSecret:
            name: aws-cloud-credentials
          deviceIndex: 0
          iamInstanceProfile:
            id: <clusterID>-worker-profile
          instanceType: m4.large
          kind: AWSMachineProviderConfig
          placement:
            availabilityZone: us-east-1a
            region: us-east-1
          securityGroups:
            - filters:
                - name: tag:Name
                  values:
                    - <clusterID>-worker-sg
          subnet:
            filters:
              - name: tag:Name
                values:
                  - <clusterID>-private-us-east-1a
          tags:
            - name: kubernetes.io/cluster/<clusterID>
              value: owned
          userDataSecret:
            name: worker-user-data
----

You can create a new `<file_name>.yaml` from the example above replacing the `<clusterID>` and `<role>` values. If you are not sure about which value to set for an specific field you can check an existing MachineSet from your cluster

. View the current MachineSets.
+
----
$ oc get machinesets -n openshift-machine-api

NAME                                DESIRED   CURRENT   READY   AVAILABLE   AGE
agl030519-vplxk-worker-us-east-1a   1         1         1       1           55m
agl030519-vplxk-worker-us-east-1b   1         1         1       1           55m
agl030519-vplxk-worker-us-east-1c   1         1         1       1           55m
agl030519-vplxk-worker-us-east-1d   0         0                             55m
agl030519-vplxk-worker-us-east-1e   0         0                             55m
agl030519-vplxk-worker-us-east-1f   0         0                             55m
----

. Check values of an specific MachineSet:
+
----
$ oc get machineset <machineset_name> -n \
     openshift-machine-api -o yaml
----

. Create the new `MachineSet`:
+
----
$ oc create -f <file_name>.yaml
----

. View the list of MachineSets:
+
----
$ oc get machineset -n openshift-machine-api


NAME                                DESIRED   CURRENT   READY   AVAILABLE   AGE
agl030519-vplxk-infra-us-east-1a    1         1         1       1           11m
agl030519-vplxk-worker-us-east-1a   1         1         1       1           55m
agl030519-vplxk-worker-us-east-1b   1         1         1       1           55m
agl030519-vplxk-worker-us-east-1c   1         1         1       1           55m
agl030519-vplxk-worker-us-east-1d   0         0                             55m
agl030519-vplxk-worker-us-east-1e   0         0                             55m
agl030519-vplxk-worker-us-east-1f   0         0                             55m
----
+
When the new MachineSet is available, the `DESIRED` and `CURRENT` values match.
If the MachineSet is not available, wait a few minutes and run the command again.

. After the new MachineSet is available, check the machine status and the referenced new node:
+
----
$ oc get machine -n openshift-machine-api

status:
  addresses:
  - address: 10.0.133.18
    type: InternalIP
  - address: ""
    type: ExternalDNS
  - address: ip-10-0-133-18.ec2.internal
    type: InternalDNS
  lastUpdated: "2019-05-03T10:38:17Z"
  nodeRef:
    kind: Node
    name: ip-10-0-133-18.ec2.internal
    uid: 71fb8d75-6d8f-11e9-9ff3-0e3f103c7cd8
  providerStatus:
    apiVersion: awsproviderconfig.openshift.io/v1beta1
    conditions:
    - lastProbeTime: "2019-05-03T10:34:31Z"
      lastTransitionTime: "2019-05-03T10:34:31Z"
      message: machine successfully created
      reason: MachineCreationSucceeded
      status: "True"
      type: MachineCreation
    instanceId: i-09ca0701454124294
    instanceState: running
    kind: AWSMachineProviderStatus
----

. View the new node and confirm that the new node has the label that you specified::
+
----
$ oc get node <node_name> --show-labels
----

Review the command output and confirm that `node-role.kubernetes.io/<your_label>`
is in the `LABELS` list.

.Next steps
If you need MachineSets in other availability zones, repeat this
process to create more MachineSets.
